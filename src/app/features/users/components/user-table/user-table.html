<div class="w-full bg-white rounded-lg px-4 sm:px-6 lg:px-10 pb-8 sm:pb-10 pt-6 sm:pt-7">

    <!-- User Table Filters -->
    <div class="flex flex-col lg:flex-row w-full gap-4 mb-5">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full min-w-0 lg:flex lg:flex-row relative">

            <!-- Search Input -->
            <div class="relative w-full min-w-0 sm:col-span-2 lg:flex-1 lg:min-w-36.25">
                <input type="search"
                    class="w-full border-2 border-gray-300 pr-10 pl-4 py-2 rounded-lg text-sm sm:text-base focus:outline-none h-11 placeholder:text-gray-400"
                    placeholder="Search..." [formControl]="searchControl" />
                <i class="bx bx-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer"></i>
            </div>

            <!-- Permission Select -->
            <div class="relative w-full min-w-38 sm:col-span-1 lg:w-50">
                <ng-select [items]="permissions" [multiple]="true" bindLabel="label" bindValue="key" groupBy="group"
                    [closeOnSelect]="false" placeholder="Permissions" [ngModel]="selectedPermissions()"
                    (ngModelChange)="selectedPermissions.set($event)"
                    class="permission-select modern-select placeholder:text-gray-400">

                    <ng-template ng-optgroup-tmp>
                        <label class="flex items-center gap-2 cursor-pointer select-none">
                            <input type="checkbox" class="modern-checkbox" [checked]="isAllSelected()"
                                [indeterminate]="selectedPermissions.length > 0 && !isAllSelected()"
                                (click)="$event.stopPropagation()" (change)="toggleAll($event.target.checked)" />
                            <strong class="text-slate-700">All</strong>
                        </label>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item" let-item$="item$">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" class="modern-checkbox" [checked]="item$.selected" tabindex="-1"
                                pointer-events="none" />
                            <span class="text-slate-700">{{ item.label }}</span>
                        </div>
                    </ng-template>

                    <ng-template ng-multi-label-tmp let-items="items">
                        @if (isAllSelected()) {
                        <span class="badge badge-success">All Permissions</span>
                        }

                        @if (!isAllSelected() && items.length > 0) {
                        <span class="badge badge-warning">
                            {{ items.length }} Selected
                        </span>
                        }
                    </ng-template>

                </ng-select>
            </div>

            <!-- Date Picker -->
            <div class="w-full sm:col-span-2 lg:w-[18rem]">
                <input ngxDaterangepickerMd [(ngModel)]="dateRange" [autoApply]="false" [alwaysShowCalendars]="true"
                    [showClearButton]="true" [drops]="'down'" [opens]="'right'" [locale]="{ format: 'DD/MM/YYYY' }"
                    [linkedCalendars]="true" placeholder="Date range"
                    class="border-2 border-gray-300 px-4 py-2 rounded-lg w-full cursor-pointer text-sm sm:text-base h-11 placeholder:text-gray-400"
                    (click)="toggleDatePicker()" [title]="dateRange()?.startDate && dateRange()?.endDate 
  ? ( (dateRange()?.startDate | date:'dd/MM/yyyy':'UTC') + ' to ' + (dateRange()?.endDate | date:'dd/MM/yyyy':'UTC') )
  : ''" />
            </div>

            <!-- Page Size Select (fixed width; fits label well) -->
            <div class="relative w-full min-w-44 sm:col-span-1 lg:w-52">
                <ng-select class="users-per-page-select filter-select w-full" [items]="pageSizeOptions"
                    [clearable]="false" [searchable]="false" [ngModel]="selectedPageSize()"
                    (ngModelChange)="onPageSizeChange($event)" [closeOnSelect]="true">
                    <ng-template ng-label-tmp let-item="item">
                        <span class="text-sm sm:text-base whitespace-nowrap">
                            Users per page : <strong>{{ item }}</strong>
                        </span>
                    </ng-template>

                    <ng-template ng-option-tmp let-item="item">
                        {{ item }}
                    </ng-template>
                </ng-select>
            </div>

        </div>

        <!-- Add Task Button -->
        <div class="flex gap-2 w-full sm:col-span-1 lg:w-auto lg:shrink-0">
            <button class="cursor-pointer w-full lg:w-auto py-2 px-4 rounded-lg bg-linear-to-r from-purple-600 to-indigo-600
             text-white shadow-md shadow-purple-500/30
             hover:shadow-lg hover:shadow-purple-500/40
             lg:hover:scale-105 transition-all duration-200" (click)="addUser.emit()">
                Add User
            </button>
        </div>

    </div>

    <!-- User Table -->

    <div class="border border-gray-200 rounded-xl shadow-sm overflow-hidden bg-white">

        <!-- 1. Horizontal Scroll Container -->
        <div class="overflow-x-auto custom-scrollbar">

            <!-- 2. Table: Removed 'w-full', added 'min-w-full' to ensure it stretches if content is small, 
             but expands indefinitely if content is wide. Removed 'table-fixed'. -->
            <table class="min-w-full text-xs sm:text-sm text-left border-collapse">

                <thead class="bg-gray-50 text-gray-600 uppercase text-[10px] sm:text-xs sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="px-6 py-4 whitespace-nowrap text-center">S.No</th>
                        <th class="px-6 py-4 whitespace-nowrap text-left">User</th>
                        <th class="px-6 py-4 whitespace-nowrap text-center">Created Date</th>
                        <!-- Permissions column -->
                        <th class="px-6 py-4 whitespace-nowrap text-left">Permissions</th>
                        <th class="px-6 py-4 whitespace-nowrap text-center">Action</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-200">
                    @for (
                    user of (filteredTasks() | paginate: { itemsPerPage: itemsPerPage, currentPage: p });
                    let i = $index;
                    track user.id
                    ) {
                    <!-- Added whitespace-nowrap to the row to ensure nothing wraps -->
                    <tr class="hover:bg-gray-50 transition-colors duration-150 whitespace-nowrap"
                        (click)="viewUser.emit(user)">

                        <!-- S.No -->
                        <td class="px-6 py-4 text-center font-medium text-gray-500">
                            {{ (p - 1) * itemsPerPage + i + 1 }}
                        </td>

                        <!-- User Info: Removed 'truncate' so full name/email shows -->
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <img [src]="user.avatar || 'assets/avatar-placeholder.png'"
                                    class="w-9 h-9 rounded-full object-cover border border-gray-200 shrink-0"
                                    alt="avatar" />
                                <div>
                                    <p class="font-semibold text-gray-800 text-sm">
                                        {{ user.name }}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        {{ user.email }}
                                    </p>
                                </div>
                            </div>
                        </td>

                        <!-- Created Date -->
                        <td class="px-6 py-4 text-center text-gray-600">
                            {{ user.createdAt | date:'dd MMM yyyy' }}
                        </td>

                        <!-- Permissions: The star of the show -->
                        <td class="px-6 py-4">
                            <!-- flex-nowrap ensures one line -->
                            <div class="flex flex-nowrap items-center gap-2">
                                @if (user.permissions.length) {
                                @for (perm of user.permissions; track perm) {
                                <!-- Dynamic Classes + Ring for definition + Border -->
                                <span
                                    class="px-2.5 py-1 text-[11px] font-medium rounded-md border shadow-sm ring-1 ring-inset"
                                    [ngClass]="getPermissionClass(perm)">
                                    {{ getPermissionLabel(perm) }}
                                </span>
                                }
                                } @else {
                                <span
                                    class="px-2.5 py-1 text-[11px] font-medium rounded-md bg-gray-50 text-gray-400 border border-gray-200">
                                    No permissions
                                </span>
                                }
                            </div>
                        </td>

                        <!-- Actions -->
                        <td class="px-6 py-4 text-center" (click)="$event.stopPropagation()">
                            <div class="flex justify-center gap-3">
                                <button
                                    class="text-yellow-700 hover:text-yellow-600 hover:bg-yellow-50 px-2 py-1 rounded transition-colors duration-200 flex items-center gap-1.5 cursor-pointer"
                                    (click)="editUser.emit(user); $event.stopPropagation()">
                                    <i class="bx bx-edit text-lg"></i>
                                    <span class="text-xs font-medium">Edit</span>
                                </button>

                                <button
                                    class="text-red-700 hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded transition-colors duration-200 flex items-center gap-1.5 cursor-pointer"
                                    (click)="deleteUser.emit(user); $event.stopPropagation()">
                                    <i class="bx bx-trash text-lg"></i>
                                    <span class="text-xs font-medium">Delete</span>
                                </button>
                            </div>
                        </td>

                    </tr>
                    }
                    @empty {
                    <tr>
                        <td colspan="5" class="p-8">
                            <app-empty-state></app-empty-state>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Footer (Kept the same) -->
        <div class="w-full border-t border-gray-200 bg-white px-4 py-4">
            <!-- ... keep your existing footer code ... -->
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-end gap-3">
                <div class="text-sm text-gray-500 whitespace-nowrap">
                    Total Tasks : <span class="ml-1 font-bold text-gray-900">{{ totalItems() }}</span>
                </div>
                <!-- Pagination logic here -->
                <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
                    <!-- Keep existing pagination code -->
                    <button (click)="clearFilters()"
                        class="text-sm font-medium text-gray-500 hover:text-gray-700 hover:underline focus:outline-none cursor-pointer text-left sm:text-center clear-filters-button underline">
                        Clear Filters
                    </button>
                    @if(totalItems() > itemsPerPage && totalItems() > 0) {
                    <div class="w-full sm:w-auto overflow-x-auto pagination-sm">
                        <pagination-controls previousLabel="Prev" nextLabel="Next" [responsive]=true
                            (pageChange)="p = $event">
                        </pagination-controls>
                    </div>
                    }
                </div>
            </div>
        </div>

    </div>

    <app-loading-overlay [show]="isLoading()" text="Loading users..."></app-loading-overlay>