<div
    class="min-h-[calc(100vh-80px)] overflow-y-auto bg-linear-to-br from-slate-50 via-purple-50/30 to-indigo-50/40 p-4 sm:p-6 lg:p-8">

    <!-- Page Header -->
    <div class="max-w-5xl mx-auto mb-6">
        <h1
            class="text-2xl sm:text-3xl font-extrabold tracking-tight bg-linear-to-r from-purple-600 via-fuchsia-600 to-indigo-600 bg-clip-text text-transparent">
            My Profile
        </h1>
        <p class="text-sm text-gray-500 mt-1">Manage your account details and preferences</p>
    </div>

    <div class="max-w-5xl mx-auto flex flex-col lg:flex-row gap-6">

        <!-- ============================================ -->
        <!-- LEFT COLUMN -->
        <!-- ============================================ -->
        <div class="w-full lg:w-80 shrink-0 flex flex-col gap-6">

            <!-- ======================================== -->
            <!-- SECTION 1: Profile Overview Card -->
            <!-- ======================================== -->
            <div
                class="bg-white rounded-2xl shadow-lg shadow-purple-500/5 border border-purple-100/50 p-6 flex flex-col items-center text-center">

                <!-- Avatar -->
                <div class="relative group mb-4">
                    @if (avatarUrl()) {
                    <img [src]="avatarUrl()" alt="Profile Avatar"
                        class="w-28 h-28 sm:w-32 sm:h-32 rounded-full object-cover ring-4 ring-purple-200 shadow-lg shadow-purple-300/30" />
                    } @else {
                    <div
                        class="w-28 h-28 sm:w-32 sm:h-32 rounded-full bg-linear-to-br from-purple-500 to-indigo-600 flex items-center justify-center ring-4 ring-purple-200 shadow-lg shadow-purple-300/30">
                        <span class="text-3xl sm:text-4xl font-bold text-white">{{ initials() }}</span>
                    </div>
                    }
                    <div class="absolute bottom-1 right-1 w-5 h-5 bg-green-400 rounded-full border-[3px] border-white">
                    </div>
                </div>

                <!-- Name & Email -->
                <h2 class="text-xl font-bold text-gray-900 break-all">{{ user()?.name }}</h2>
                <p class="text-sm text-gray-500 mt-1 break-all">{{ user()?.email }}</p>

                <!-- Role Badge -->
                <div class="mt-3">
                    @if (user()?.parentId && user()?.parentId !== '-1') {
                    <span
                        class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">
                        <i class='bx bx-user text-sm'></i> Team Member
                    </span>
                    } @else {
                    <span
                        class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-700">
                        <i class='bx bx-crown text-sm'></i> Admin
                    </span>
                    }
                </div>

                <!-- Edit Button -->
                @if (!isEditing) {
                <button (click)="startEditing()"
                    class="mt-5 w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl bg-linear-to-r from-purple-600 to-indigo-600 text-white text-sm font-semibold shadow-md shadow-purple-500/25 hover:shadow-lg hover:shadow-purple-500/40 hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 cursor-pointer">
                    <i class='bx bx-edit-alt text-lg'></i>
                    Edit Profile
                </button>
                }
            </div>

            <!-- ======================================== -->
            <!-- SECTION 2: Activity & Membership Card -->
            <!-- ======================================== -->
            <div class="bg-white rounded-2xl shadow-lg shadow-purple-500/5 border border-purple-100/50 p-5">
                <div class="flex items-center gap-3 mb-5">
                    <div
                        class="w-9 h-9 rounded-xl bg-linear-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                        <i class='bx bx-clock-5 text-lg text-white'></i>
                    </div>
                    <h3 class="text-sm font-bold text-gray-800">Activity & Membership</h3>
                </div>

                <div class="space-y-4">
                    <!-- Member Since -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center shrink-0">
                            <i class='bx bx-calendar text-xl text-emerald-600'></i>
                        </div>
                        <div class="min-w-0">
                            <p class="text-xs text-gray-400 font-medium">Member Since</p>
                            <p class="text-sm font-semibold text-gray-800 truncate">{{ memberSince() }}</p>
                        </div>
                    </div>

                    <!-- Account Age -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-teal-50 flex items-center justify-center shrink-0">
                            <i class='bx bx-timer text-xl text-teal-600'></i>
                        </div>
                        <div class="min-w-0">
                            <p class="text-xs text-gray-400 font-medium">Account Age</p>
                            <p class="text-sm font-semibold text-gray-800">{{ accountAge() }}</p>
                        </div>
                    </div>

                    <!-- Account Status -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-green-50 flex items-center justify-center shrink-0">
                            <i class='bx bx-check-circle text-xl text-green-600'></i>
                        </div>
                        <div class="min-w-0">
                            <p class="text-xs text-gray-400 font-medium">Status</p>
                            <span
                                class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                Active
                            </span>
                        </div>
                    </div>

                    <!-- Access Level -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-green-50 flex items-center justify-center shrink-0">
                            <i class='bx bx-bar-chart-square text-xl text-green-600'></i>
                        </div>
                        <div class="min-w-0">
                            <p class="text-xs text-gray-400 font-medium">Access Level</p>
                            <p class="text-sm font-semibold" [ngClass]="{
                                    'text-green-700': accessLevel() === 'Full Access',
                                    'text-amber-700': accessLevel() === 'Standard Access',
                                    'text-gray-700': accessLevel() === 'Limited Access' || accessLevel() === 'No Access'
                                }">
                                {{ accessLevel() }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ============================================ -->
        <!-- RIGHT COLUMN -->
        <!-- ============================================ -->
        <div class="flex-1 flex flex-col gap-6 min-w-0">

            <!-- ======================================== -->
            <!-- EDIT FORM (conditionally shown) -->
            <!-- ======================================== -->
            @if (isEditing) {
            <div class="bg-white rounded-2xl shadow-lg shadow-purple-500/5 border border-purple-100/50 p-6 sm:p-8">
                <div class="flex items-center gap-3 mb-6">
                    <div
                        class="w-10 h-10 rounded-xl bg-linear-to-br from-purple-500 to-indigo-600 flex items-center justify-center">
                        <i class='bx bx-edit text-xl text-white'></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Edit Profile</h3>
                        <p class="text-xs text-gray-400">Update your personal information</p>
                    </div>
                </div>

                <div class="space-y-5">
                    <!-- Name Field -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                            <i class='bx bx-user text-purple-500 mr-1'></i>Full Name
                        </label>
                        <input type="text" [(ngModel)]="editForm.name" placeholder="Enter your name"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50/50 text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent transition" />
                    </div>

                    <!-- Avatar URL Field -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                            <i class='bx bx-image text-purple-500 mr-1'></i>Avatar URL
                        </label>
                        <input type="text" [(ngModel)]="editForm.avatar" placeholder="https://example.com/avatar.jpg"
                            class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50/50 text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent transition" />
                        <p class="text-xs text-gray-400 mt-1.5">Paste a direct image URL for your profile picture</p>
                    </div>

                    <!-- Avatar Preview -->
                    @if (editForm.avatar.trim()) {
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">Preview</label>
                        <img [src]="editForm.avatar" alt="Avatar Preview"
                            class="w-20 h-20 rounded-full object-cover ring-2 ring-purple-200"
                            (error)="editForm.avatar = ''" />
                    </div>
                    }

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-2">
                        <button (click)="saveProfile()" [disabled]="isSaving"
                            class="flex-1 flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-linear-to-r from-purple-600 to-indigo-600 text-white text-sm font-semibold shadow-md shadow-purple-500/25 hover:shadow-lg hover:shadow-purple-500/40 hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                            @if (isSaving) {
                            <i class='bx bx-loader-alt bx-spin text-lg'></i>
                            Saving...
                            } @else {
                            <i class='bx bx-check text-lg'></i>
                            Save Changes
                            }
                        </button>
                        <button (click)="cancelEditing()" [disabled]="isSaving"
                            class="flex-1 flex items-center justify-center gap-2 px-5 py-3 rounded-xl border-2 border-gray-200 text-gray-600 text-sm font-semibold hover:bg-gray-50 hover:border-gray-300 active:scale-[0.98] transition-all duration-200 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class='bx bx-x text-lg'></i>
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
            }

            <!-- ======================================== -->
            <!-- SECTION 3: Account Details Card -->
            <!-- ======================================== -->
            <div class="bg-white rounded-2xl shadow-lg shadow-purple-500/5 border border-purple-100/50 p-6 sm:p-8">
                <div class="flex items-center gap-3 mb-6">
                    <div
                        class="w-10 h-10 rounded-xl bg-linear-to-br from-purple-500 to-indigo-600 flex items-center justify-center">
                        <i class='bx bx-user-circle text-xl text-white'></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Account Details</h3>
                        <p class="text-xs text-gray-400">Your identity and account configuration</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Full Name -->
                    <div class="bg-gray-50/80 rounded-xl p-4 border border-gray-100">
                        <div class="flex items-center gap-2 mb-1.5">
                            <i class='bx bx-user text-purple-500'></i>
                            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Full Name</span>
                        </div>
                        <p class="text-sm font-semibold text-gray-800 break-all">{{ user()?.name }}</p>
                    </div>

                    <!-- Email -->
                    <div class="bg-gray-50/80 rounded-xl p-4 border border-gray-100">
                        <div class="flex items-center gap-2 mb-1.5">
                            <i class='bx bx-envelope text-purple-500'></i>
                            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Email
                                Address</span>
                        </div>
                        <p class="text-sm font-semibold text-gray-800 break-all">{{ user()?.email }}</p>
                    </div>

                    <!-- User ID -->
                    <div class="bg-gray-50/80 rounded-xl p-4 border border-gray-100">
                        <div class="flex items-center justify-between mb-1.5">
                            <div class="flex items-center gap-2">
                                <i class='bx bx-fingerprint text-purple-500'></i>
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">User
                                    ID</span>
                            </div>
                            <button (click)="copyUserId()"
                                class="text-gray-400 hover:text-purple-600 transition-colors cursor-pointer"
                                title="Copy ID">
                                <i class='bx text-base'
                                    [ngClass]="idCopied ? 'bx-check text-green-500' : 'bx-copy'"></i>
                            </button>
                        </div>
                        <p class="text-sm font-mono font-semibold text-gray-600 truncate" [title]="user()?.id ?? ''">
                            {{ user()?.id }}
                        </p>
                    </div>

                    <!-- Account Type -->
                    <div class="bg-gray-50/80 rounded-xl p-4 border border-gray-100">
                        <div class="flex items-center gap-2 mb-1.5">
                            <i class='bx bx-id-card text-purple-500'></i>
                            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Account
                                Type</span>
                        </div>
                        @if (user()?.parentId && user()?.parentId !== '-1') {
                        <span
                            class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                            <i class='bx bx-user text-xs'></i> Team Member
                        </span>
                        } @else {
                        <span
                            class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                            <i class='bx bx-crown text-xs'></i> Admin
                        </span>
                        }
                    </div>

                    <!-- Parent Account (Full Width) -->
                    <div class="sm:col-span-2 bg-gray-50/80 rounded-xl p-4 border border-gray-100">
                        <div class="flex items-center gap-2 mb-1.5">
                            <i class='bx bx-git-branch text-purple-500'></i>
                            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Parent
                                Account</span>
                        </div>
                        @if (user()?.parentId && user()?.parentId !== '-1') {
                        <div class="flex items-center gap-2">
                            <span
                                class="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg text-sm font-semibold bg-blue-50 text-blue-700 border border-blue-200">
                                <i class='bx bx-link text-sm'></i>
                                Managed by Admin (ID: {{ user()?.parentId }})
                            </span>
                        </div>
                        } @else {
                        <div class="flex items-center gap-2">
                            <span
                                class="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg text-sm font-semibold bg-purple-50 text-purple-700 border border-purple-200">
                                <i class='bx bx-buildings text-sm'></i>
                                Root Account â€” No Parent
                            </span>
                        </div>
                        }
                    </div>
                </div>
            </div>

            <!-- ======================================== -->
            <!-- SECTION 4: Permissions & Access Card -->
            <!-- ======================================== -->
            <div class="bg-white rounded-2xl shadow-lg shadow-purple-500/5 border border-purple-100/50 p-6 sm:p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-linear-to-br from-fuchsia-500 to-purple-600 flex items-center justify-center">
                            <i class='bx bx-lock-open-alt text-xl text-white'></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">Permissions & Access</h3>
                            <p class="text-xs text-gray-400">Access rights assigned to your account</p>
                        </div>
                    </div>

                    <!-- Permission Count Badge -->
                    <div
                        class="hidden sm:flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-purple-50 border border-purple-200">
                        <i class='bx bx-key text-sm text-purple-600'></i>
                        <span class="text-xs font-bold text-purple-700">{{ permissionLabels().length }} / 5</span>
                    </div>
                </div>

                <!-- Access Level Summary Bar -->
                <div class="mb-5 p-4 rounded-xl border border-gray-100" [ngClass]="{
                        'bg-green-50/80': accessLevel() === 'Full Access',
                        'bg-amber-50/80': accessLevel() === 'Standard Access',
                        'bg-gray-50/80': accessLevel() === 'Limited Access' || accessLevel() === 'No Access'
                    }">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Access Level</span>
                        <span class="text-sm font-bold" [ngClass]="{
                                'text-green-700': accessLevel() === 'Full Access',
                                'text-amber-700': accessLevel() === 'Standard Access',
                                'text-gray-700': accessLevel() === 'Limited Access' || accessLevel() === 'No Access'
                            }">
                            {{ accessLevel() }}
                        </span>
                    </div>
                    <!-- Progress Bar -->
                    <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500" [ngClass]="{
                                'bg-green-500': accessLevel() === 'Full Access',
                                'bg-amber-500': accessLevel() === 'Standard Access',
                                'bg-gray-400': accessLevel() === 'Limited Access' || accessLevel() === 'No Access'
                            }" [style.width.%]="(permissionLabels().length / 5) * 100">
                        </div>
                    </div>
                </div>

                <!-- Permissions Grid -->
                @if (permissionLabels().length > 0) {
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    @for (perm of permissionLabels(); track perm.key) {
                    <div class="flex items-center gap-3 rounded-xl p-3.5 border border-gray-100 hover:border-purple-200 hover:shadow-sm transition-all duration-200"
                        [ngClass]="getPermissionColor(perm.key)">
                        <div class="w-9 h-9 rounded-lg flex items-center justify-center shrink-0 bg-white/60">
                            <i class='bx text-lg' [ngClass]="permissionIcon[perm.key] || 'bx-check-shield'"></i>
                        </div>
                        <div class="min-w-0">
                            <span class="text-sm font-semibold block">{{ perm.label }}</span>
                            <span class="text-[10px] font-mono text-gray-400">{{ perm.key }}</span>
                        </div>
                    </div>
                    }
                </div>

                <!-- Missing Permissions -->
                @if (missingPermissions().length > 0) {
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Not Granted</p>
                    <div class="flex flex-wrap gap-2">
                        @for (perm of missingPermissions(); track perm.key) {
                        <span
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-400 border border-gray-200 line-through">
                            <i class='bx bx-lock-alt text-xs'></i>
                            {{ perm.label }}
                        </span>
                        }
                    </div>
                </div>
                }

                } @else {
                <div class="text-center py-8">
                    <div class="w-16 h-16 mx-auto rounded-full bg-gray-100 flex items-center justify-center mb-3">
                        <i class='bx bx-lock text-2xl text-gray-400'></i>
                    </div>
                    <p class="text-sm text-gray-500 font-medium">No permissions assigned</p>
                    <p class="text-xs text-gray-400 mt-1">Contact your admin for access</p>
                </div>
                }
            </div>

        </div>
    </div>
</div>